<UserControl x:Class="OctoEspetos.Views.OrdersDashboardView"
             x:DataType="vm:OrdersDashboardViewModel"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns="https://github.com/avaloniaui"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:OctoEspetos.ViewModels"
             xmlns:m="using:OctoEspetos.Models"
             d:DesignHeight="720"
             d:DesignWidth="1280"
             mc:Ignorable="d">
  <Design.DataContext>
    <vm:OrdersDashboardViewModel />
  </Design.DataContext>
  <Panel>
  <Grid RowDefinitions="Auto, *">
    <Border Background="#252526" Padding="15" Grid.Row="0">
      <Grid x:Name="HeaderGrid" RowDefinitions="Auto, Auto" ColumnDefinitions="Auto, *, Auto, Auto">
        <Button Content="⬅"
                Command="{Binding GoBackCommand}"
                Background="Transparent"
                Foreground="White"
                FontSize="32"
                Padding="15,5"
                BorderThickness="0"
                Grid.Column="0" Grid.Row="0"/>
        
        <StackPanel x:Name="RevenuePanel" 
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    Orientation="Horizontal"
                    Spacing="10"
                    Grid.Column="2" Grid.Row="0">
          <TextBlock VerticalAlignment="Center"
                     Foreground="#AAA"
                     Text="FATURAMENTO TOTAL:" />
          <TextBlock FontSize="24"
                     FontWeight="Bold"
                     Foreground="#4CC2FF"
                     Text="{Binding TotalRevenueToday, StringFormat='R$ {0:N2}'}" />
        </StackPanel>
        
        <Button Content="⟳"
                Command="{Binding LoadDataCommand}"
                Background="Transparent"
                Foreground="#4CC2FF"
                FontSize="32"
                Padding="15,5"
                BorderThickness="0"
                Margin="10,0,0,0"
                Grid.Column="3" Grid.Row="0"/>
      </Grid>
    </Border>
    <TabControl Margin="10" Grid.Row="1">
      <TabItem Header="HISTÓRICO DE VENDAS" FontSize="16" FontWeight="SemiBold">
        <Grid RowDefinitions="Auto, *">
          <StackPanel Margin="0,0,0,10"
                      Orientation="Horizontal"
                      Spacing="10">
            <TextBlock VerticalAlignment="Center" Text="Data:" FontSize="16"/>
            <DatePicker SelectedDate="{Binding SelectedDate}" />
            <Button Content="Filtrar" Command="{Binding LoadDataCommand}" FontSize="16"/>
          </StackPanel>
          <DataGrid AutoGenerateColumns="False"
                    Background="#2D2D30"
                    GridLinesVisibility="Horizontal"
                    IsReadOnly="True"
                    RowHeight="50"
                    FontSize="16"
                    ItemsSource="{Binding FinishedOrders}"
                    Grid.Row="1">
            <DataGrid.Columns>
              <DataGridTextColumn Width="80" Binding="{Binding Id}" Header="#" />
              <DataGridTextColumn Width="100"
                                  Binding="{Binding CreatedAt, StringFormat='HH:mm'}"
                                  Header="Hora" />
              <DataGridTextColumn Width="*"
                                  Binding="{Binding Client.Name}"
                                  Header="Cliente" />
              <DataGridTextColumn Width="140"
                                  Binding="{Binding TotalAmount, StringFormat='R$ {0:N2}'}"
                                  FontWeight="Bold"
                                  Header="Total" />
            </DataGrid.Columns>
          </DataGrid>
        </Grid>
      </TabItem>
      <TabItem Header="PEDIDOS ABERTOS" FontSize="16" FontWeight="SemiBold">
        <ScrollViewer>
          <ItemsControl ItemsSource="{Binding OpenOrders}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel x:Name="OpenOrdersWrapPanel" ItemHeight="210" ItemWidth="220" />
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="m:Order">
                <Border Margin="5"
                        Background="#3E3E42"
                        CornerRadius="5"
                        Padding="15">
                  <Grid RowDefinitions="Auto, *, Auto, Auto">
                    <TextBlock FontSize="18"
                               FontWeight="Bold"
                               Text="{Binding Client.Name, TargetNullValue='Walk-in'}" />
                    <StackPanel Grid.Row="1" Margin="0,5">
                      <TextBlock Foreground="#AAA"
                                 Text="{Binding Id, StringFormat='Pedido #{0}'}" />
                      <TextBlock Foreground="#888" FontSize="14"
                                 Text="{Binding CreatedAt, StringFormat='Aberto: {0:HH:mm}'}" />
                    </StackPanel>
                    <TextBlock Grid.Row="2"
                               Margin="0,5"
                               FontSize="24"
                               FontWeight="Bold"
                               Foreground="#4CC2FF"
                               Text="{Binding TotalAmount, StringFormat='R$ {0:N2}'}" />
                    <Grid Grid.Row="3" ColumnDefinitions="*, *" Margin="0,10,0,0">
                      <Button Grid.Column="0"
                              Content="EDITAR"
                              Background="#007ACC"
                              Foreground="White"
                              FontWeight="Bold"
                              FontSize="14"
                              Height="40"
                              HorizontalContentAlignment="Center"
                              VerticalContentAlignment="Center"
                              HorizontalAlignment="Stretch"
                              Margin="0,0,5,0"
                              Command="{Binding $parent[UserControl].((vm:OrdersDashboardViewModel)DataContext).EditOrderCommand}"
                              CommandParameter="{Binding}" />
                      <Button Grid.Column="1"
                              Content="PAGAR"
                              Background="#28a745"
                              Foreground="White"
                              FontWeight="Bold"
                              FontSize="14"
                              Height="40"
                              HorizontalContentAlignment="Center"
                              VerticalContentAlignment="Center"
                              HorizontalAlignment="Stretch"
                              Margin="5,0,0,0"
                              Command="{Binding $parent[UserControl].((vm:OrdersDashboardViewModel)DataContext).PayOrderCommand}"
                              CommandParameter="{Binding}" />
                    </Grid>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </TabItem>
    </TabControl>
  </Grid>

  <!-- Modal de Pagamento -->
  <Border IsVisible="{Binding IsPaymentModalVisible}"
          Background="#80000000"
          HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch">
      <Border Background="#2D2D30" 
              CornerRadius="12"
              Padding="20"
              Width="450"
              MaxHeight="550"
              VerticalAlignment="Center"
              HorizontalAlignment="Center"
              BoxShadow="0 8 32 0 #40000000">
          <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Spacing="15">
              
              <TextBlock Text="CONFIRMAR PAGAMENTO" 
                         FontSize="22" FontWeight="Bold" 
                         Foreground="#4CC2FF"
                         HorizontalAlignment="Center"/>
              
              <Border Background="#1E1E1E" CornerRadius="8" Padding="15">
                  <StackPanel Spacing="8">
                      <Grid ColumnDefinitions="*, Auto">
                          <TextBlock Text="Cliente:" Foreground="#AAA"/>
                          <TextBlock Grid.Column="1" Text="{Binding SelectedPaymentOrder.Client.Name}" Foreground="White" FontWeight="SemiBold"/>
                      </Grid>
                      <Grid ColumnDefinitions="*, Auto">
                          <TextBlock Text="Pedido #:" Foreground="#AAA"/>
                          <TextBlock Grid.Column="1" Text="{Binding SelectedPaymentOrder.Id}" Foreground="White"/>
                      </Grid>
                      <Separator Background="#444" Height="1" Margin="0,5"/>
                      <Grid ColumnDefinitions="*, Auto">
                          <TextBlock Text="TOTAL:" Foreground="White" FontWeight="Bold" FontSize="18"/>
                          <TextBlock Grid.Column="1" 
                                     Text="{Binding SelectedPaymentOrder.TotalAmount, StringFormat='R$ {0:N2}'}" 
                                     Foreground="#4CC2FF" FontWeight="Bold" FontSize="22"/>
                      </Grid>
                  </StackPanel>
              </Border>
              
              <Grid ColumnDefinitions="Auto, *">
                  <TextBlock Text="Pagamento:" Foreground="#AAA" VerticalAlignment="Center" Margin="0,0,15,0"/>
                  <ComboBox Grid.Column="1"
                            ItemsSource="{Binding PaymentMethods}"
                            SelectedItem="{Binding SelectedPaymentMethod}"
                            HorizontalAlignment="Stretch"
                            Background="#333"
                            CornerRadius="6"/>
              </Grid>
              
              <StackPanel Spacing="10" IsVisible="{Binding SelectedPaymentMethod, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                  <!-- Mostrar campos de troco APENAS se for Dinheiro -->
                  <StackPanel IsVisible="{Binding SelectedPaymentMethod, Converter={x:Static ObjectConverters.Equal}, ConverterParameter='Dinheiro'}">
                      <Grid ColumnDefinitions="Auto, *">
                          <TextBlock Text="Recebido:" Foreground="#AAA" VerticalAlignment="Center" Margin="0,0,15,0"/>
                          <TextBox Grid.Column="1"
                                   Text="{Binding AmountReceived}"
                                   Background="#333" Foreground="White"
                                   FontSize="20" FontWeight="Bold"
                                   CornerRadius="6" Padding="12,8"
                                   Watermark="0,00"/>
                      </Grid>
                      <Grid ColumnDefinitions="Auto, *" Margin="0,10,0,0">
                          <TextBlock Text="Troco:" Foreground="#AAA" VerticalAlignment="Center" Margin="0,0,15,0"/>
                          <TextBlock Grid.Column="1"
                                     Text="{Binding ChangeAmount, StringFormat='R$ {0:N2}'}"
                                     FontSize="24" FontWeight="Bold"
                                     Foreground="{Binding ChangeAmount, Converter={x:Static ObjectConverters.IsNull}, ConverterParameter=#28A745|#FF6B6B}"/>
                      </Grid>
                  </StackPanel>
              </StackPanel>
              
              <Grid ColumnDefinitions="*, 15, *" Margin="0,10,0,0">
                  <Button Content="❌ CANCELAR"
                          Command="{Binding CancelPaymentCommand}"
                          Background="#666" Foreground="White"
                          FontWeight="Bold" FontSize="15"
                          HorizontalAlignment="Stretch"
                          HorizontalContentAlignment="Center"
                          Height="50" CornerRadius="8"/>
                  
                  <Button Grid.Column="2" 
                          Content="✅ CONFIRMAR"
                          Command="{Binding ConfirmPaymentCommand}"
                          Background="#28A745" Foreground="White"
                          FontWeight="Bold" FontSize="15"
                          HorizontalAlignment="Stretch"
                          HorizontalContentAlignment="Center"
                          Height="50" CornerRadius="8"/>
              </Grid>
          </StackPanel>
          </ScrollViewer>
      </Border>
  </Border>
  </Panel>
</UserControl>